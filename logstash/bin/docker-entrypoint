#!/bin/bash -e

# Map environment variables to entries in logstash.yml.
# Note that this will mutate logstash.yml in place if any such settings are found.
# This may be undesirable, especially if logstash.yml is bind-mounted from the
# host system.
env2yaml /usr/share/logstash/config/logstash.yml

if [[ -n $PEM_CERT ]] &&
   [[ -s $PEM_CERT ]] &&
   [[ -n $PEM_KEY ]] &&
   [[ -s $PEM_KEY ]] &&
   [[ -z $PEM_TO_KEYSTORE_OUT ]] ; then
  echo "INFO: Building ${PEM_TO_KEYSTORE_OUT} from ${PEM_CERT} and ${PEM_KEY}"
cat << RUBY_SCRIPT | /usr/bin/env ruby
require 'openssl'
pkcs12 = OpenSSL::PKCS12.create(
  "changeit",
  "server",
  OpenSSL::PKey.read File.read("${PEM_KEY}"),
  OpenSSL::X509::Certificate.new File.read("${PEM_CERT}")
)
File.open("${PEM_TO_KEYSTORE_OUT}", 'w'){|f| f << pkcs12.to_der }
RUBY_SCRIPT
fi

export LS_JAVA_OPTS="-Dls.cgroup.cpuacct.path.override=/ -Dls.cgroup.cpu.path.override=/ $LS_JAVA_OPTS"

if [[ -z $1 ]] || [[ ${1:0:1} == '-' ]] ; then
  exec logstash "$@"
else
  exec "$@"
fi
